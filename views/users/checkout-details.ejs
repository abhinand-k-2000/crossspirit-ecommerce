<%- include('../layouts/header') %>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<!-- Bootstrap JavaScript -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

		<!--end top header wrapper-->
		<!--start page wrapper -->
		<div class="page-wrapper">
			<div class="page-content">
				<!--start breadcrumb-->
				<section class="py-3 border-bottom border-top d-none d-md-flex bg-light">
					<div class="container">
						<div class="page-breadcrumb d-flex align-items-center">
							<h3 class="breadcrumb-title pe-3">Checkout</h3>
							<div class="ms-auto">
								<nav aria-label="breadcrumb">
									<ol class="breadcrumb mb-0 p-0">
										<li class="breadcrumb-item"><a href="javascript:;"><i class="bx bx-home-alt"></i> Home</a>
										</li>
										<li class="breadcrumb-item"><a href="javascript:;">Shop</a>
										</li>
										<li class="breadcrumb-item active" aria-current="page">Checkout</li>
									</ol>
								</nav>
							</div>
						</div>
					</div>
				</section>
				<!--end breadcrumb-->
				<!--start shop cart-->
					<section class="py-4">
						<div class="container">
							<div class="shop-cart">
								<div class="row">
									<div class="col-12 col-xl-8">
										<div class="checkout-details">
											<div class="card bg-transparent rounded-0 shadow-none">
												<div class="card-body">
													<div class="steps steps-light">
														<a class="step-item active" href="shop-cart.html">
															<div class="step-progress"><span class="step-count">1</span>
															</div>
															<div class="step-label"><i class='bx bx-cart'></i>Cart</div>
														</a>
														<a class="step-item active current" href="checkout-details.html">
															<div class="step-progress"><span class="step-count">2</span>
															</div>
															<div class="step-label"><i class='bx bx-user-circle'></i>Details</div>
														</a>
														<!-- <a class="step-item" href="checkout-shipping.html">
															<div class="step-progress"><span class="step-count">3</span>
															</div>
															<div class="step-label"><i class='bx bx-cube'></i>Shipping</div>
														</a> -->
														<a class="step-item" href="checkout-payment.html">
															<div class="step-progress"><span class="step-count">3</span>
															</div>
															<div class="step-label"><i class='bx bx-credit-card'></i>Payment</div>
														</a>
														<!-- <a class="step-item" href="checkout-review.html">
															<div class="step-progress"><span class="step-count">5</span>
															</div>
															<div class="step-label"><i class='bx bx-check-circle'></i>Review</div>
														</a> -->
													</div>
												</div>
											</div>
											<div class="card rounded-0">
												<div class="card-body">
													<div class="d-flex align-items-center mb-3">
														
														<div class="ms-2">
															<h6 class="mb-0"><%= user.name %></h6>
															<p class="mb-0"><%= user.email %>></p>
														</div>
														<div class="ms-auto">	<a href="#" class="btn btn-light btn-ecomm" data-toggle="modal" data-target="#addAddressModal">
															<i class='bx bx-edit'></i> Add Address
														</a>
															<!-- <button class="btn btn-dark mb-2" data-toggle="modal" data-target="#addAddressModal">Add Address</button> -->
														</div>
													</div>
	
													<% if (address && Array.isArray(address) && address.length > 0) { %>
														<div class="border p-3">
															<h2 class="h5 mb-3">Shipping Address</h2>
															<div class="form-body">
																<form action="" class="row g-3" id="addressForm">
																	<div class="col-md-12 mb-3">
																		<label for="addressSelect" class="form-label">Select Address:</label>
																		<select class="form-select" id="addressSelect" name="selectedAddress">
																			<option value="" selected disabled>Choose Address</option>
																			<% address.forEach((add) => { %>
																				<option value="<%= add._id %>"><%= add.streetaddress %>, <%= add.city %>, <%= add.state %>, <%= add.pincode %></option>
																			<% }) %>
																		</select>
																	</div>
																	<div class="col-md-12 mt-3">
																		<div class="d-grid gap-2 d-md-flex justify-content-md-between">
																			<a href="/cart" class="btn btn-light btn-ecomm"><i class='bx bx-chevron-left'></i>Back to Cart</a>
																			<a href="#" class="btn btn-dark btn-ecomm" onclick="submitForm()">Continue <i class='bx bx-chevron-right'></i></a>
																		</div>
																	</div>
																</form>
															</div>
														</div>
													<% } %>
													
													
													
													
 													
													
																						
												</div>
											</div>
										</div>
									</div>

								
									<div class="col-12 col-xl-4">
										<div class="order-summary">
											
											<span class="text-primary " style="cursor: pointer;" onclick="toggleCouponSection()">View Coupons</span>

										 <!-- Display available coupons (initially hidden) -->
        <div id="couponSection" class="card rounded-0 border bg-transparent shadow-none mb-3" style="display: none;">
            <div class="card-body">
                <p class="fs-5">Available Coupons</p>
                <ul>
                    <% coupons.forEach((coupon) => { %>
                        <li><span class="fw-bolder"><%= coupon.couponCode %></span> - <%= coupon.couponDescription %></li>
                    <% }) %>
                </ul>
            </div>
        </div>


		<!-- <script>
			function toggleCouponSection() {
				var couponSection = document.getElementById('couponSection');
				if (couponSection.style.display === 'none') {
					couponSection.style.display = 'block';
				} else {
					couponSection.style.display = 'none';
				}
			}
		</script> -->
											<div class="card rounded-0">
												
												<div class="card-body">
													<div class="card rounded-0 border bg-transparent shadow-none mb-3">
														<div class="card-body">
															<p class="fs-5">Apply Discount Code</p>

														
																<!-- <form id="removeCouponForm" action="/coupon/remove-coupon" method="post" onsubmit="removeCouponFormSubmit(event)">
																	<button id="removeCouponButton" class="btn btn-dark btn-ecomm" type="submit" >Remove Coupon</button>
																</form> -->

															
																	<button id="removeCouponBtn" class="btn btn-dark btn-ecomm" style="display: none;"  onclick="removeCoupon()">Remove Coupon</button>
														
																	<div class="input-group" id="applyCouponButton">
																		<input type="text" class="form-control rounded-0" name="couponCode" id="couponCode" placeholder="Enter coupon code">
																		<button  class="btn btn-dark btn-ecomm mt-1" id="applyCouponBtn" type="button" onclick="applyCoupon()">Apply</button>
																	</div>
															
															
																	
														
															
															
															
															
															
															
															
															
															
														
															  
															  
															
															
														</div>
														<span id="couponError" style="display: none;" class="text-center text-danger"></span>
													</div>
													
													<div class="card rounded-0 border bg-transparent shadow-none">
														<div class="card-body">
															<p class="fs-5">Order summary</p>
															<% products.forEach((prod, index) => { %>
																<div class="my-3 border-top"></div>
																<div class="d-flex align-items-center">
																	<a class="d-block flex-shrink-0" href="javascript:;">
																		<img src="/products/<%= prod.imageUrl[0] %>" width="75" alt="Product">
																	</a>
																	<div class="ps-2">
																		<h6 class="mb-1"><a href="javascript:;" class="text-dark"><%= prod.name %></a></h6>
																		<div class="widget-product-meta"><span class="me-2"><%= prod.price %></span><span class="">x <%= prod.quantity %></span>
																		</div>
																	</div>
																</div>
															<% }) %>
														</div>
													</div>
	
													<div class="card rounded-0 border bg-transparent mb-0 shadow-none">
														<div class="card-body">
															<p class="mb-2">Subtotal: <span class="float-end">Rs. <%= cart.items.reduce((acc, item) => acc + item.totalPrice, 0) %></span></p>

															</p>
															<p class="mb-2">Shipping: <span class="float-end">--</span>
															</p>
															<p class="mb-2">Dicount: <span class="float-end" id="showDiscount">--</span>
															</p>
															<!-- <p class="mb-0">Discount: 
																
																	<span  class="float-end"></span>
															
																	<span class="float-end">--</span>
															
																
															</p> -->
															<div class="my-3 border-top"></div>
															<h5 class="mb-0">Order Total: <span class="float-end" id="orderTotal">Rs. <%= cart.totalProductsPrice %></span></h5>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
								<!--end row-->
							</div>
						</div>
					</section>
			</div>
		</div>
		<!--end page wrapper -->

		<!--------------------------------------- Starting of Add Address Modal ---------------------------------------------------------->

		<div class="modal fade" id="addAddressModal" tabindex="-1" role="dialog" aria-labelledby="addAddressModalLabel" aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="addAddressModalLabel">Add Address</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<form id="addAddressForm" action="/add-address" method="POST" onsubmit="return validateForm()">
							<!-- Address form fields -->
							<div class="form-row mb-3">
								<div class="form-group col">
									<label for="modalStreetAddress">Street Address</label>
									<input type="text" class="form-control" id="modalStreetAddress" name="streetAddress" required>
								</div>
							</div>
							<div class="form-row mb-3">
								<div class="form-group col">
									<label for="modalCity">City</label>
									<input type="text" class="form-control" id="modalCity" name="city" required>
								</div>
							</div>
							<div class="form-row mb-3">
								<div class="form-group col">
									<label for="modalState">State</label>
									<input type="text" class="form-control" id="modalState" name="state" required>
								</div>
							</div>
							<div class="form-row mb-3">
								<div class="form-group col">
									<label for="modalZipCode">Zip Code</label>
									<input type="text" class="form-control" id="modalZipCode" name="pinCode" pattern="\d*" title="Please enter only numbers" required>
								</div>
							</div>
							 <!-- Include the source parameter as a hidden input field -->
							<input type="hidden" name="source" value="checkoutDetail">
							<!-- End of address form fields -->
		
							<div class="modal-footer">
								<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
								<button type="submit" class="btn btn-primary">Save Address</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
		<!--------------------------------------- End of Add Address Modal ---------------------------------------------------------->

		
		  

		<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<!-- SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

		<!-- <script>
			$(document).ready(function() {
				// Function to handle form submission
				function submitForm() {
					// Check if any radio button is checked
					if ($('input[name="selectedAddress"]:checked').length > 0) {
						// Form has selected address, proceed to checkout
						window.location.href = "/checkout-payment?id=" + $('input[name="selectedAddress"]:checked').val();
					} else {
						// No address selected, show a sweet alert
						Swal.fire({
							icon: 'warning',
							title: 'Oops...',
							text: 'Please select an address before proceeding to checkout.',
							confirmButtonColor: '#3085d6',
							confirmButtonText: 'OK'
						});
					}
				}
			
				// Attach click event to the "Proceed to Checkout" button
				$('.btn-ecomm.btn-dark').on('click', function(e) {
					e.preventDefault(); // Prevent the default action of the anchor tag
			
					// Call the submitForm function
					submitForm();
				});
			});
			</script> -->

			<script src="/userAssets/js/checkout.js"></script>
			
		 

		
		<%- include('../layouts/footer') %>